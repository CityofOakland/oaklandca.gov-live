{% if slug %}
  {% set entry = craft.entries().section('departments').slug(slug).one() %}
  {% if not entry  %}
    {% redirect 404 %}
  {% endif %}
{% else %}
  {% redirect 404 %}
{% endif %}

{% set filter_enabled = false %}
{% set homepage = craft.entries().section('homepage').one() %}
{% set department_title = entry.legalTitle ? entry.legalTitle : entry.title %}
{% set newsIndex = craft.entries().section('newsIndex').one() %}
{% set news = craft.entries()
    .section('news')
    .relatedTo(entry)
    .orderBy('postDate desc')
    .limit(10) %}

{# Search query #}
{% set search = craft.app.request.getQueryParam('search') ? craft.app.request.getQueryParam('search') : '' %}
{% if search %}
  {% set news = news.search(search) %}
  {% set filter_enabled = true %}
{% endif %}

{# Filter by date #}
{% set year = craft.app.request.getQueryParam('year') ? craft.app.request.getQueryParam('year') : '' %}
{% set month = craft.app.request.getQueryParam('month') ? craft.app.request.getQueryParam('month') : '' %}
{% set ymd = '' %}
{% set date_query = ['and'] %}
{% if year and month %}
  {% set filter_enabled = true %}
  {% set ymd = year ~ '-' ~ month ~ '-01' %}
  {% set date_query = date_query|merge(['>= ' ~ (ymd), '< ' ~ (ymd|date_modify('+1 month')|date('Y-m-d')) ]) %}
{% elseif year %}
  {% set filter_enabled = true %}
  {% set ymd = year ~ '-' ~ '01-01' %}
  {% set date_query = date_query|merge(['>= ' ~ (ymd), '< ' ~ (ymd|date_modify('+1 year')|date('Y-m-d')) ]) %}
{% elseif month %}
  {% set filter_enabled = true %}
  {% set ymd = now|date('Y') ~ '-' ~ month %}
  {% set date_query = date_query|merge(['>= ' ~ (ymd), '< ' ~ (ymd|date_modify('+1 month')|date('Y-m-d')) ]) %}
{% endif %}
{% if date_query|length > 1 %}
  {% set news = news.postDate(date_query) %}
{% endif %}

{% paginate news as pageInfo, news %}

{% if pageInfo.currentPage > 1 %}
  {% set filter_enabled = true %}
{% endif %}

{# SEO Title #}
{% set seoTitle = department_title ~ ' News' %}
{% if pageInfo.currentPage > 1 %}
  {% set seoTitle = seoTitle ~ ' | Page ' ~ pageInfo.currentPage ~ ' of ' ~ pageInfo.totalPages %}
{% endif %}
{% do seomatic.meta.seoTitle(seoTitle) %}

{# Extending parent layout and other imports #}
{% set layout = 'filter' %}
{% extends '_content.twig' %}
{% import '_macros/_macros' as macros %}

{# Banner #}
{% block banner %}
  {% include '_partials/_page-banners.twig' with {
    breadCrumbLinks: [
      {
        title: 'Oakland',
        link: homepage.url
      },
      {
        title: department_title,
        link: entry.url
      }
    ],
    bannerImage: entry.banner|length ? {
      position: entry.banner.one().getFocalPoint('asCss'),
      src: entry.banner.one().url,
      alt: entry.banner.one().title ?? entry.banner.one().filename
    } : false,
    bannerTitle: 'News',
    custHeaderContent: null
  } %}
{% endblock %}

{# Title Section #}
{% block title %}
  <h1 class="my-0 text-3xl font-bold md:text-4xl">{{ department_title }} Department News</h1>
  <div class="mt-4 text-xl leading-8 tw-only">The latest news from the {{ department_title }} Department</div>
{% endblock %}

{# Related Content Section #}
{%- set relatedContentSection -%}
  <h4 class="mt-4 mb-6 py-0">{{ 'Related'|t }}</h4>

  <a class="mb-4 block" href="{{ entry.url }}">{{ department_title }}</a>
  <a href="{{ newsIndex.url }}">Oakland News</a>
{%- endset -%}

{# Content Section #}
{% block content %}
  <h2 aria-live="polite">
    {% if filter_enabled %}
      {% if news|length %}
        Displaying {{ news|length }} of {{ pageInfo.total }} News
      {% else %}
        No results found
      {% endif %}
    {% else %}
      Displaying All News and Press Releases
    {% endif %}
  </h2>

  <div class="mt-8">
    {% if news|length %}
      {% for news_item in news %}
        {% include '_components/_news-index-item' %}
      {% endfor %}
    {% else %}
      <div class="bg-gray-100 px-8 pt-3 pb-5">
        <p>Please try another search or updating your filters.</p>
        <div class="my-4">
          <a href="{{ craft.app.request.url }}">See All News</a>
        </div>
      </div>
    {% endif %}
  </div>
  <div class="my-8">
    {% include '_partials/_elements/_pagination' %}
  </div>

  <div class="mb-4 lg:oak-hidden">
    <hr class="hr dark">
    {{ relatedContentSection }}
  </div>
{% endblock %}

{# Search & Filter Sidebar #}
{% block sidebar %}
  <hr>

  <h4 class="mt-4 mb-6 py-0">{{ 'Search & Filter'|t }}</h4>

  <form action="{{ craft.app.request.url }}">
    {# Month filter drop-down #}
    {{ macros.select('Month', 'month', 'month', [
        {"01"  : "January"},
        {"02"  : "February"},
        {"03"  : "March"},
        {"04"  : "April"},
        {"05"  : "May"},
        {"06"  : "June"},
        {"07"  : "July"},
        {"08"  : "August"},
        {"09"  : "September"},
        {"10"  : "October"},
        {"11"  : "November"},
        {"12"  : "December"}
      ], "Select a month"
    )}}

    {# Year filter drop-down #}
    {% set earliest_year = craft.entries()
        .section('news')
        .orderBy('postDate asc')
        .limit(1)
        .one()
        .postDate|date('Y') %}
    {% set latest_year = craft.entries()
        .section('news')
        .orderBy('postDate desc')
        .limit(1)
        .one()
        .postDate|date('Y') %}
    {% set years = [] %}
    {% for year in range(latest_year, earliest_year) %}
      {% set years = years|merge([{(year): year}]) %}
    {% endfor %}
    {{ macros.select('Year', 'year', 'year', years, "Select a year") }}

    {# Search input field #}
    {{ macros.textInput('Search', 'search', 'search', 'Search a keyword') }}

    {# Search & filter section's buttons #}
    <div class="flex items-center">
      <button class="button medium">Apply</button>
      <a class="mt-4" href="{{ craft.app.request.pathInfo }}">Clear filters</a>
    </div>
  </form>

  <hr class="hr dark">

  <div class="oak-hidden lg:block">
    {{ relatedContentSection }}
  </div>
{% endblock %}
