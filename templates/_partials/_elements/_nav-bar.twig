{% set mainNav = [
  { title: "News",          url: siteUrl ~ "departments/media-center" },
  { title: "Services",      url: siteUrl ~ "services" },
  { title: "Departments",   url: siteUrl ~ "departments" },
  { title: "Calendar",      url: siteUrl ~ "calendar" },
  { title: "City Council",  url: siteUrl ~ "departments/oakland-city-council" }
] %}

{% import '_macros/_macros.twig' as macros %}

<div id="nav-wrapper" class="fixed z-40 w-full" role="navigation">
    <div id="nav-bar" x-data="{ openNav: false }" class="relative z-50 block w-full trans trans-fast nav-bar">
        <div class="relative z-40 bg-gray-1000">
            <nav id="main-navigation" class="flex items-stretch justify-between py-3 lg:py-5" name="Main Navigation" role="navigation">
                <button @click="openNav = true" class="flex items-center justify-center w-16 -my-3 text-gray-900 bg-green-500 fill-current lg:-my-5 touch-action-none lg:oak-hidden hover:bg-green-700 hover:text-gray-1000">
                    {{ craft.inlin.er('/assets/img/icon-menu.svg') | replace('<svg ', '<svg class="h-9 md:h-10 xl:oak-hidden" ') | raw }}
                </button>
                <a id="home-link" class="flex items-center justify-center h-full px-2 text-gray-100 fill-current hover:text-gray-200 trans-fast" href="{{ siteUrl }}" name="Home">
                    {{ craft.inlin.er('/assets/img/logo-oakland-tree.svg') | replace('<svg ', '<svg class="h-9 sm:h-10 w-14 md:h-10 sm:oak-hidden" ') | raw }}
                    {{ craft.inlin.er('/assets/img/logo-oakland.svg') | replace('<svg ', '<svg class="w-40 h-10 oak-hidden sm:block" ') | raw }}
                    <span class="hidden-visually">Home</span>
                </a>
                <form id="site-search-form" class="relative z-0 flex justify-end flex-1 pl-4 pr-6 lg:pr-0" action="{{ url('search') }}" role="search">
                    <label for="site-search" class="hidden-visually">Search?</label>
                    <input type="search" id="site-search" class="z-10 w-full pl-10 pr-6 mb-0 text-sm leading-normal text-gray-100 placeholder-gray-200 bg-gray-900 border-2 border-gray-800 rounded appearance-none search-box h-9 md:h-10 md:text-base" aria-label="Site Search" name="query" placeholder="Search" value="">
                </form>
                <ul class="lg:ml-3 pr-6 mr-6 text-xs tracking-wide border-r border-gray-700 lg:flex oak-hidden lg:my-0 lg:justify-end lg:items-center xl:text-sm">
                    {% for nav in mainNav %}
                        {% if nav.title == "Services" %}
                            <li class="dropdown dropdown-megamenu">
                                <a href="{{ nav.url }}" class="px-2 py-3 text-gray-100 hover:bg-white hover:text-black uppercase font-bold" id="navbar-dropdown-{{ nav.title|kebab }}" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{ nav.title }} {{ svg( '@webroot/assets/img/icon-arrow.svg') }}</a>
                                {% set navSubitems = craft.categories
                                    .group("serviceTypes")
                                    .limit(10)
                                    .level(1)
                                    .orderBy("lft ASC")
                                    .all()
                                %}
                                {% set reportProblem = craft.categories.group("serviceTypes").slug("report-a-problem").one() %}
                                {% set applyPermit = craft.categories.group("serviceTypes").slug("apply-for-a-permit").one() %}
                                <div class="dropdown-container bg-green-800" aria-labelledby="navbar-dropdown-{{ nav.title|kebab }}">
                                    <div class="container components py-0">
                                        <ul id="megamenu" class="grid md:grid-cols-3 gap-3" style="list-style: none;padding:0;">
                                            {% nav subitem in navSubitems %}
                                                {{ macros.card(subitem, false) }}
                                            {% endnav %}
                                            {% if reportProblem %}
                                                {{ macros.card(reportProblem, true, true) }}
                                            {% endif %}
                                            {% if applyPermit %}
                                                {{ macros.card(applyPermit, true, true) }}
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li><a href="{{ nav.url }}" class="px-2 py-3 text-gray-100 hover:text-gray-200 hover:underline trans-fast uppercase font-bold">{{ nav.title }}</a></li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <div class="pr-2 lg:items-center oak-hidden lg:flex">
                    <a href="/officials/libby-schaaf" class="flex items-center text-xs text-gray-100 hover:text-gray-200" title="View the homepage of Libby Schaaf, The Mayor of the City of Oakland">
                        <div class="mx-2 leading-tight text-right oak-hidden xl:block">
                            <div><span class="font-bold">{{"Mayor"|t}}</span></div>
                            <div>{{"Libby Schaaf"|t}}</div>
                        </div>
                        <img src="https://city-of-oakland.imgix.net/portraits/oakland_mayor_libby_schaaf_city_of_oakland-1519844049-5198.jpg?auto=compress%2Cformat&amp;crop=focalpoint&amp;fit=min&amp;fp-x=0.5&amp;fp-y=0.5&amp;h=64&amp;q=80&amp;w=64" sizes="100vw" srcset="https://city-of-oakland.imgix.net/portraits/oakland_mayor_libby_schaaf_city_of_oakland-1519844049-5198.jpg?auto=compress%2Cformat&amp;crop=focalpoint&amp;fit=min&amp;fp-x=0.5&amp;fp-y=0.5&amp;h=128&amp;q=80&amp;w=128 128w, https://city-of-oakland.imgix.net/portraits/oakland_mayor_libby_schaaf_city_of_oakland-1519844049-5198.jpg?auto=compress%2Cformat&amp;crop=focalpoint&amp;fit=min&amp;fp-x=0.5&amp;fp-y=0.5&amp;h=64&amp;q=80&amp;w=64 64w" alt="Portrait of Mayor, Libby Schaaf" class="block w-10 h-10 border-2 border-gray-800 rounded-full">
                    </a>
                    <a href="/services/oak311" class="flex ml-2" title="Report a problem online to OAK 311">
                        <img src="https://city-of-oakland.imgix.net/news/311-Logo.png?auto=compress%2Cformat&amp;crop=focalpoint&amp;fit=min&amp;fp-x=0.5&amp;fp-y=0.5&amp;h=64&amp;q=80&amp;w=64" sizes="100vw" srcset="https://city-of-oakland.imgix.net/news/311-Logo.png?auto=compress%2Cformat&amp;crop=focalpoint&amp;fit=min&amp;fp-x=0.5&amp;fp-y=0.5&amp;h=128&amp;q=80&amp;w=128 128w, https://city-of-oakland.imgix.net/news/311-Logo.png?auto=compress%2Cformat&amp;crop=focalpoint&amp;fit=min&amp;fp-x=0.5&amp;fp-y=0.5&amp;h=64&amp;q=80&amp;w=64 64w" alt="OAK 311 Logo" class="block w-10 h-10 border-2 border-gray-800 rounded-full">
                        <span style="display:none;">{{"Oak 311"|t}}</span>
                    </a>
                </div>
            </nav>
        </div>
        {# BEGIN MOBILE NAV #}
        <div
            class="relative z-30 py-0 bg-gray-1000" x-show="openNav" @click.away="openNav = false" x-cloak>
            <ul class="container justify-end overflow-y-scroll flex-1 w-full pt-0 pb-4 mx-auto my-0 text-lg" style="height: 100vh;">
                {% for nav in mainNav %}
                    {% if nav.title == "Services" %}
                        <li class="border-t border-gray-600">
                            <div class="flex items-center justify-between py-4">
                                <a class="text font-normal text-gray-100 hover:text-gray-200 fill-current" href="{{ nav.url }}">{{ nav.title }}</a>
                                <div class="text font-normal text-gray-100 fill-current p-1 rounded bg-gray-800 subnav-toggler">{{ craft.inlin.er('/assets/img/icon-arrow.svg') | replace('<svg ', '<svg class="w-4 h-4 xl:oak-hidden" style="transform: rotate(90deg);" ') | raw }}</div>
                            </div>

                            {% set navSubitems = craft.categories
                                .group("serviceTypes")
                                .limit(10)
                                .orderBy("title asc")
                                .all()
                            %}
                            {% set reportProblem = craft.categories.group("serviceTypes").slug("report-a-problem").one() %}
                            {% set applyPermit = craft.categories.group("serviceTypes").slug("apply-for-a-permit").one() %}
                            <div class="subnav overflow-y-scroll">
                                <ul class="my-0 bg-white font-bold">
                                    {% nav subitem in navSubitems %}
                                        <li class="border-t border-gray-600"><a class="block h-full p-4" href="{{ subitem.url }}">{{ subitem.title }}</a></li>
                                    {% endnav %}
                                    {% if reportProblem %}<li class="border-t border-gray-600"><a class="block h-full p-4 flex items-center justify-between bg-blue-100 text-blue-1000" href="{{ reportProblem.url }}">{{ reportProblem.title }}<span class="arrow-right text-blue-1000 text-lg" role="img" aria-label="arrow right">&rarr;</span></a></li>{% endif %}
                                    {% if applyPermit %}<li class="border-t border-gray-600"><a class="block h-full p-4 flex items-center justify-between bg-blue-100 text-blue-1000" href="{{ applyPermit.url }}">{{ applyPermit.title }}<span class="arrow-right text-blue-1000 text-lg" role="img" aria-label="arrow right">&rarr;</span></a></li>{% endif %}
                                </ul>
                            </div>
                        </li>
                    {% else %}
                    <li class="{% if not loop.first %}border-t {% endif %}border-gray-600">
                        <a class="flex items-center justify-between py-4 font-normal text-gray-100 hover:text-gray-200 fill-current" href="{{ nav.url }}"><div class="text">{{ nav.title }}</div></a>
                    </li>
                    {% endif %}
                {% endfor %}
                <li class="border-t border-gray-600">
                    <a class="flex items-center justify-between py-4 font-normal text-gray-100 hover:text-gray-200 fill-current" href="/topics/oaklandlovelife"><div class="text">#OaklandLoveLife</div></a>
                </li>
                <li class="border-t border-gray-600">
                    <a class="flex items-center justify-between py-4 font-normal text-gray-100 hover:text-gray-200 fill-current" href="/officials/libby-schaaf"><div class="text">Mayor Libby Schaaf</div></a>
                </li>
                <li class="border-t border-gray-600">
                    <a class="flex items-center justify-between py-4 font-normal text-gray-100 hover:text-gray-200 fill-current" href="/services/oak311"><div class="text">Report a problem to OAK 311</div></a>
                </li>
            </ul>
        </div>
        {# END MOBILE NAV #}
    </div>
</div>

<style>
    .dropdown.dropdown-megamenu .dropdown-container {
        display: none;
        padding: 1rem 0;
        position: fixed;
        top: 80px;
        left: 0;
        width: 100%;
    }

    @media(min-width: 1280px) {
        .dropdown.dropdown-megamenu .dropdown-container {
            top: 83px;
        }
    }

    .dropdown.dropdown-megamenu .dropdown-container::before {
        background: black;
        content: "";
        opacity: 0.25;
        pointer-events: none;
        position: absolute;
        top: 100%;
        bottom: 0;
        left: 0;
        height: 100vh;
        width: 100%;
    }

    @media(min-width: 1024px) {
        .dropdown.dropdown-megamenu .dropdown-container {
            padding: 0.75rem 0;
            max-height: calc(100vh - 80px);
        }
    }

    .dropdown.dropdown-megamenu .dropdown-container .components h4 {
        font-size: 16px;
        padding-bottom: 0.5rem !important;
    }

    .dropdown.dropdown-megamenu .dropdown-container .components p {
        font-size: 14px;
    }

    .dropdown.dropdown-megamenu > a {
        background: transparent;
        display: flex;
        margin-top: -20px;
        margin-bottom: -20px;
        padding-top: 31px;
        padding-bottom: 31px;
        position: relative;
    }

    .dropdown.dropdown-megamenu > a > svg {
        margin-left: 5px;
        transform: rotateZ(90deg);
        width: 10px;
    }

    .dropdown.dropdown-megamenu > a > svg path {
        fill: white;
    }

    .dropdown.dropdown-megamenu > a:focus + .dropdown-container,
    .dropdown.dropdown-megamenu:focus-within .dropdown-container {
        display: block !important;
    }

    .dropdown.dropdown-megamenu:hover > a,
    .dropdown.dropdown-megamenu:focus-within > a,
    .dropdown.dropdown-megamenu > a:focus,
    .dropdown.dropdown-megamenu.state-active > a {
        background: #207127;
        color: white;
    }

    .dropdown.dropdown-megamenu:hover > .dropdown-container,
    .dropdown.dropdown-megamenu.state-active > .dropdown-container {
        display: block;
    }

    #megamenu .card:hover,
    #megamenu .card:focus {
        background: #0D5713;
    }

    #megamenu .card h4 {
        color: #FFF3C4;
    }

    #megamenu .card p {
        color: white;
    }

    #megamenu .card span {
        text-decoration: none;
    }

    #megamenu .card.dark {
        background: #FFF3C4;
    }

    #megamenu .card.dark:hover,
    #megamenu .card.dark:focus {
        background: #FFFBEA;
    }

    #megamenu .card.dark h4 {
        color: #207127;
    }

    #megamenu .card.dark p {
        color: #000000;
    }

    @media(max-height: 739px) {
        #megamenu h4 {
            padding-bottom: 0 !important;
        }

        #megamenu .card {
            padding: 10px 20px;
        }

        #megamenu .card:not(.dark) {
            border-bottom: 1px solid #3E9141;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        #megamenu .clamp {
            display: none;
        }
    }

    .subnav {
        display: none;
    }

    .subnav.state-active {
        display: block;
    }
</style>

{% js on load %}
    $('#site-search-form').on('submit', function(){
        var search_term = $('#site-search').val();

        dl.push({
            'event'                 : 'site_search_clicked',
            'current_url'           : '{{ craft.app.request.absoluteUrl }}',
            'input_search_term'     : search_term,
            'debug_mode'            : true,
        });
    });

    $('#nav-wrapper a').on('click', function(){
        var link_clicked    = $(this).attr('href').trim();
        var link_label      = $(this).text().trim().replace(/(\r\n|\n|\r)/gm, "");

        dl.push({
            'event'         : 'topnav_clicked',
            'current_url'   : '{{ craft.app.request.absoluteUrl }}',
            'url'           : link_clicked,
            'label'         : link_label,
            'debug_mode'    : true,
        });
    });

    $('.subnav-toggler').on('click', function(){
        $(this).parent().siblings('.subnav').toggle('state-active');
    });

    $('.dropdown-megamenu').on('mouseenter', function(){
        $(this).addClass('state-active');
    })

    $('.dropdown-megamenu').on('mouseleave', function(){
        setTimeout(function(){
            $('.dropdown-megamenu').removeClass('state-active');
        }, 500);
    })
{% endjs %}
