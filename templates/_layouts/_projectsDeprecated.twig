{% extends "_layouts/_banner-with-nav.twig" %}

{% do craft.app.elements.eagerLoadElements(
	className(entry),
	[entry],
	['banner']
) %}

{% set timeline = entry.timeline.all() ?? null %}

{% set beforePhoto = entry.projectBeforePhoto.one() ?? null %}
{% set afterPhoto = entry.projectAfterPhoto.one() ?? null %}

{% set relatedNews = craft.entries.section('news').relatedTo(entry) %}

{% set contactState = entry.addresses | length or entry.address or entry.phoneNumbers | length or entry.emailAddress | length or entry.openHours | length %}

{% block content %}
	{% set breadcrumbs = [] %}
	{% if entry.primaryUnit|length %}
		{% set breadcrumbs = breadcrumbs|merge([
			{
				title: entry.primaryUnit.one().title,
				link: entry.primaryUnit.one().url
			},
		]) %}
	{% endif %}
	{% if entry.section %}
		{% set breadcrumbs = breadcrumbs|merge([
			{
				title: entry.section.name,
				link: siteUrl ~ entry.section.handle
			},
		]) %}
	{% endif %}

	{{ include("_partials/_page-banners.twig", {
		breadCrumbLinks: breadcrumbs,
		navMenu: {
			'timeline': entry.timeline.exists(),
			'about': true,
			'contact': contactState,
			'logos': entry.fundingLogos.exists(),
		},
		bannerImage: entry.banner | length ? {
			position: entry.banner[0].getFocalPoint('asCss'),
			src: entry.banner[0].url,
			alt: entry.banner[0].title ?? entry.banner[0].filename
		} : false

	}) }}

	{{ include("_css/timeline.css") }}

	{% js %}
		{{ include("_js/timeline.js") }}
		timeline(document.querySelectorAll('.timeline'));
	{% endjs %}

	<section id="content">
		<a class="anchor-link" id="page-timeline"></a>
		<div class="container">
			<div class="md:flex md:flex-row">
				<div class="md:pr-4 md:w-1/2">
					{% if timeline %}
						{{ include("_partials/_elements/_module-header.twig", {
							headerText: "Timeline"
						}) }}
						<div class="timeline" data-vertical-start-position="right">
							<div class="timeline__wrap">
								<div class="timeline__items">
									{% for block in timeline %}
										<div class="timeline__item">
											<div class="timeline__content">
												<h3 class="my-0 text-xl font-bold">{{ block.milestoneName }}</h3>
												<p>{{ block.milestoneDates }}</p>
											</div>
										</div>
									{% endfor %}
								</div>
							</div>
						</div>
					{% endif %}
				</div>
				<div class="md:pl-4 md:w-1/2">
					{% set mapImage = entry.projectMapImage.one() ?? null %}
					{% if mapImage %}
						{% set src = mapImage.getUrl('thumbFullRatio') %}
						{% set transformedImages = craft.imagerx.transformImage(mapImage, "medium43") %}
						{{ include("_partials/_elements/_module-header.twig", {
							headerText: "Project Location"
						}) }}
						<figure class="block w-full">
							<img
								class="block"
								src="{{ craft.imager.placeholder({ type: 'silhouette', width: 400, height: 300, source: src }) }}"
								sizes="100vw"
								srcset="{{ craft.imager.srcset(transformedImages) }}"
								alt="Map of {{ entry.title }}"
							>
						</figure>
					{% endif %}
				</div>
			</div>
		</div>
	</section>
	{% if beforePhoto and afterPhoto %}
		<section>
			<a class="anchor-link" id="page-gallery"></a>
			<div class="container">
				<div class="md:flex md:flex-row">
					<div class="md:pr-4 md:w-1/2">
						<h3>Current</h3>
						<figure class="block w-full">
							<img
								src="{{ beforePhoto.getUrl('medium43') }}"
								class="block"
								alt="{{ beforePhoto.altText ?? beforePhoto.title }}"
							>
						</figure>
					</div>
					<div class="md:pl-4 md:w-1/2">
						<h3>Projected/After</h3>
						<figure class="block w-full">
							<img
								src="{{ afterPhoto.getUrl('medium43') }}"
								class="block"
								alt="{{ afterPhoto.altText ?? afterPhoto.title }}"
							>
						</figure>
					</div>
				</div>
				<div>
					{% set attributes = {
						class: 'btn py-2 mt-4 text-sm',
						"data-custom": 'custom-data-attribute'
					} %}
					{{ entry.externalPhotoGallery.link(attributes) }}
				</div>
			</div>
		</section>
	{% endif %}
	<section>
		<a class="anchor-link" id="page-about"></a>
		<div class="container md:flex md:flex-row">
			<div class="md:pr-4 md:w-2/3">
				<h3 class="mb-4">About</h3>
				<div class="body-text">
					{{ entry.about }}
				</div>
			</div>
			<div class="md:pl-4 md:w-1/3">
				<h3 class="mb-4">Project Updates</h3>
				{% for entry in craft.entries.section('news').relatedTo(entry).all() %}
					<a href="{{ entry.url }}" class="mb-4 block bg-gray-300 p-4 hover:bg-green-800 text-gray-1000 hover:text-white">
						<h4 class="mt-0 mb-2 text-sm">{{ entry.title }}</h4>
						<p class="my-0 text-xs">{{ entry.postDate | date() }}</p>
					</a>
				{% else %}
					<h4 class="mt-0 mb-2 text-sm">No updates, yet! Check back soon!</h4>
				{% endfor %}
			</div>
		</div>
	</section>
	<section>
		<a class="anchor-link" id="page-resources"></a>
		<div class="container md:flex md:flex-row">
			{% set relProj = entry.relatedProjectEntries %}
			{% set projDocs = entry.projectDocuments %}
			{% if relProj | length %}
				<div {% if projDocs %} class="md:pr-4 md:w-2/3" {% endif %}>
					<h3>Related Pages</h3>
					<div class="card-grid">
						{% for entry in relProj.all() %}
							{{ include("_partials/_elements/_title-cards.twig", {
								cardColor: 'bg-gray-300'
							}) }}
						{% endfor %}
					</div>
				</div>
			{% endif %}
			{% if projDocs | length %}
				<div {% if relProj %} class="md:pl-4 md:w-1/3" {% endif %}>
					<h3 class="mb-10">Project Documents</h3>
					{% for entry in projDocs.all() %}
						<a href="{{ entry.url }}" class="mt-4 block bg-gray-300 p-4 hover:bg-green-800 text-gray-1000 hover:text-white">
							<h4 class="my-0 text-sm">{{ entry.title }}</h4>
						</a>
					{% endfor %}
				</div>
			{% endif %}
		</div>
	</section>
	<div class="container">
		{{ include("_partials/_page-location.twig") }}
	</div>
	{% if entry.fundingLogos.exists() %}
		<section>
			<a class="anchor-link" id="page-logos"></a>
			<div class="container">
				<h3 class="mb-4 text-center">Project Funding</h3>
				<div class="-mx-4 flex flex-wrap items-center justify-center">
					{% for logo in entry.fundingLogos.all() %}
						<figure class="mx-4 mb-4 w-full sm:w-1/2 md:w-1/3 lg:w-1/5 md:mb-8">
							<img class="mx-auto block h-auto w-full" src="{{ logo.url }}" alt="{{ logo.title }}">
						</figure>
					{% endfor %}
				</div>
			</div>
		</section>
	{% endif %}
{% endblock %}